import pandas as pd
import numpy as np
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import TruncatedSVD
import warnings
warnings.filterwarnings('ignore', category=UserWarning)  # Suppress warnings

# Step 1: Data Preparation
print("Step 1: Preparing data for TruncatedSVD...")

# Select numeric columns (float64 and int64)
numeric_cols = df_customer.select_dtypes(include=['float64', 'int64']).columns
df_numeric = df_customer[numeric_cols]
print(f"Selected {len(numeric_cols)} numeric features for TruncatedSVD: {list(numeric_cols)}")

# Normalize the data
scaler = StandardScaler()
df_scaled = scaler.fit_transform(df_numeric)
df_scaled = pd.DataFrame(df_scaled, columns=numeric_cols, index=df_customer.index).astype('float32')
print("Data normalized to zero mean and unit variance")

# Step 2: Dimensionality Reduction with TruncatedSVD
print("Step 2: Running TruncatedSVD dimensionality reduction...")
svd = TruncatedSVD(
    n_components=2,      # Reduce to 2D for clustering and visualization
    random_state=42      # Reproducibility
)
embedding = svd.fit_transform(df_scaled)
embedding = pd.DataFrame(embedding, columns=['SVD1', 'SVD2'], index=df_customer.index).astype('float32')
print(f"TruncatedSVD reduction complete: Shape of embedding = {embedding.shape}")
print(f"Explained variance ratio: {svd.explained_variance_ratio_}")
print(f"Total explained variance: {sum(svd.explained_variance_ratio_):.4f}")

# Step 3: Add embedding to original DataFrame
df_customer['SVD1'] = embedding['SVD1']
df_customer['SVD2'] = embedding['SVD2']
print(f"Added SVD1 and SVD2 to df_customer. New shape: {df_customer.shape}")

# Step 4: Save embedding for clustering
embedding.to_pickle('svd_embedding.pkl')
print("TruncatedSVD embedding saved to 'svd_embedding.pkl'")

# Optional: Visualize SVD embedding (requires matplotlib)
try:
    import matplotlib.pyplot as plt
    plt.figure(figsize=(10, 6))
    plt.scatter(embedding['SVD1'], embedding['SVD2'], s=1, alpha=0.5)
    plt.title('TruncatedSVD Embedding of Customers')
    plt.xlabel('SVD1')
    plt.ylabel('SVD2')
    plt.savefig('svd_visualization.png')
    plt.close()
    print("TruncatedSVD visualization saved to 'svd_visualization.png'")
except ImportError:
    print("Matplotlib not installed. Skipping visualization.")
